def send_bits(bits):
    tip = 1
    ring = 1j
    tb = 0
    for bit in bits:
        if type(bit) == type((1,2)):
            if bit[0] == "wait":
                for i in range(bit[1]):
                    yield 1+1j-(tb*tip+(not bit)*ring)
            if bit[0] == "zeros":
                for i in range(bit[1]):
                    yield 1+1j-(tb*tip+(not 0)*ring) #dc restoration
                    yield 1+1j-(tb*tip+0*ring)
                    tb = not tb
                    yield 1+1j-(tb*tip+0*ring)
                    yield 1+1j-(tb*tip+(not 0)*ring) #dc restoration

        else:
            yield 1+1j-(tb*tip+(not bit)*ring) #dc restoration
            yield 1+1j-(tb*tip+bit*ring)
            tb = not tb
            yield 1+1j-(tb*tip+bit*ring)
            yield 1+1j-(tb*tip+(not bit)*ring) #dc restoration
def to_bitstream(dat):
    for i in range(16):#sync pulse
        yield 0
    for d in dat:
        if type(d) == type((1,2)):
            yield d
        else:
            yield 1
            for i in range(8):
                yield ((1<<i)&d)>0

def transfer(dat,n=96000//1024):
    for i in send_bits(to_bitstream(dat)):
        for j in range(n):
            yield i

    
graphic_bootstrap = "F33E01D310CD0B003E20D310CD0B003E05D310AFD300060648210F9E1EAACDF39D7ABE2806210F9E4118F3230520EFCDF39D4A41CDF39D72237A814F10F6C0E536ED2336B02336C323369523369D2B2B2B11159E37ED52444DEB11959DC91600DB00AB1F3808DB04CB5F20F4E1C9CB0BAB1FCB1A30EA7AD311C953746172743A"

save_prog_bootstrap = "F33E01D310CD0B003E20D310CD0B003E05D310AFD300060A48210E9E1EAACDF29D7ABE2806210E9E4118F3230520EF060821199ECDF29D7223101721189ED5E7D1CDF29D6ACDF29D62D5E5EF3943C1EB23D1CDF29D23720B78B120F6C91600DB00AB1F3808DB04CB5F20F4E1C9CB0BAB1FCB1A30EA7AD311C9537461727450726F673A050000000000000000"

save_prog_ramcode_bootstrap = "F3ED73CC813E01D32011DC81CD448121E3810605CD8A8111F781010A00CD628121F681E72AFF81EF3943D511E981CD448121F0810605CD8A81ED4BFF81D11313CD6281C9210002224B84EBEF0A45F33E01D310CD0B003E20D310CD0B003E05D310C904210000CDA0811213856F3001240D20F310F1CDA081BD2007CDA081BC2001C911CE81CD4481183A48545DCDA081BE280541626B18F52310F23E21D310C9D516001EAADB00AB1F3808DB04CB5F20F41811CB0BAB1FCB1A30EA7B32A4817AD311D1C9ED7BCC81AFD300C900006572723A20636865636B73756D0052656164793A204E616D653A0052656164793A20504461743A0005"
#                                                                                 504461743a

big_bootstrap_prog = "F3AFD300060848211C9E1EAACD039E7ABE2806211C9E4118F3230520EFCD039E4204CD039E4A0CCD039E722310F90D20F6CD039E4ACD039E42E536ED2336B02336C323369523369D2B2B2B11249E37ED52E5D5E56069C11A13856F3001240B78B120F47CB5E111959DC1B7C8E1C91600DB00AB1F3808DB04CB5F20F4E1C9CB0BAB1FCB1A30EAC942696750726F673A"

def bootDat(hexStr,start = "Start:"):
    #hexStr += "00"
    assert len(hexStr)%2 == 0
    l = (len(hexStr)//2)+1
    assert l<=256
    byts = [l]+[int(hexStr[i*2:i*2+2],16) for i in range(l-1)]
    byts += [(-sum(byts))%256] #checksum
    return [ord(c) for c in start]+byts+[0]

def bootstrap(hexStr,dupe=96,start="Start:"):
    for i in transfer(bootDat(hexStr,start),dupe):
        yield i
        
def big_bootstrap(hexStr,dupe=96,start="BigProg:"):
    assert len(hexStr)%2 == 0
    l = (len(hexStr)//2)
    assert l<3700
    byts = [int(hexStr[i*2:i*2+2],16) for i in range(l)]
    checksum = (-sum(byts))%65536
    byts += [checksum%256,checksum//256]
    for i in transfer([0]*16+[ord(c) for c in start]+[l%256,l//256]+byts,dupe):
        yield i

def two_byte_checksummed(dat):
    return dat+[sum(dat)%256,sum(dat)//256]
def send_prog(name,contents,dupe=96,w1=256,w2=256):
    assert len(name) <= 8
    nameDat = ([ord(i) for i in name] + [0]*8)[:8]
    contentsDat = [ord(i) for i in contents]
    lenContents = len(contentsDat)
    namePacket = [ord(i) for i in "Name:"]+two_byte_checksummed(nameDat+[lenContents%256,lenContents//256])
    datPacket = [ord(i) for i in "PDat:"]+two_byte_checksummed(contentsDat)
    spacer = [0xaa,0x55]*4
    dat = bootDat(save_prog_ramcode_bootstrap,"Code:") + [("zeros",w1)] +spacer+ namePacket+ [("zeros",w2)]+spacer+datPacket+spacer
    for i in transfer(dat,dupe):
        yield i

    
def load(hexStr,dupe=96,forceBig=0):
    assert len(hexStr)%2 == 0
    l = (len(hexStr)//2)
    if l < 250 and not forceBig:
        for i in bootstrap(hexStr,dupe):
            yield i
    else:
        for i in bootstrap(big_bootstrap_prog,dupe):
            yield i
        for i in range(dupe*50):
            yield 0
        for i in big_bootstrap(hexStr,dupe):
            yield i


audioProg = "BB6D3E01D320F33EFFD3012A1D9E3A1B9E5F3EFDD3014E234623DD214000CDC3A7DB011F380E2A1D9ECD329E21EC86221D9E18D31F38093A1B9E3D321B9E18C71F38093A1B9E3C321B9E18BB1F381A3A1C9E3C47CD1F9E7E23B628AB3A1C9E3C321C9E2B221D9E189E1F38143A1C9E3DCB7F2093321C9E47CD1F9E221D9E18871F3884AFD300FBC90000519E21519E78B7C85E23562313CB3ACB1B1910F4C911EC864E234623EB71237023EB03CB38CB197EE6EE0F1223130B78B120F4C904000F0F10000123456789ABCDEF1E000123456789ABCDEFEDCBA98765432179018888888899999999AAAAAAAABBBBBBBBCCCCCCCCCDDDDDDDDDDEEEEEEEEEEEEEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEEEEEEEEEEEEEDDDDDDDDDDCCCCCCCCCCBBBBBBBBAAAAAAAA999999988888888777777776666666555555554444444433333333332222222222111111111111100000000000000000000000000000000000000000000000000000000000001111111111111222222222233333333344444444555555556666666677777770BC0088889999AAAABBBBCCCCCDDDDDEEEEEEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEEEEEEDDDDDCCCCCBBBBAAAA999988887776666555544443333322222111111000000000000000000000000000000011111122222333334444555566667775E008899AABBCCCDDEEEFFFFFFFFFFFFFFFFEEEDDCCCBBAA998876655443332211100000000000000001112233344556672F0089ABCCDEFFFFFFFFEEDCBA9876543211000000001233456018008ACDEFFFEDCA8532100012350C008CEFEC83101306008EE81103008E1079017888898899999A99AAAAAABAABBBBBCCCCBCCCCCDDDDDDDDDDDEEDEDEEEEEEEFFFFEEEFEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFEFFFFFFEFFEEEFEEDDEDEDDDDDDDDDCDCCCCCCCCBBBBBBABABBAA9AAAA9998988888887877777776666666565555544444444443343333233332222221111111111111010001010000000000000000000000000000000000000000000000000000010011111111121222222323333333333334444444445555566566666677777870BC00889899A99AAABBBBBCCCDDDDDEEDEEFFEEFFFFFFFFFFFFFFFFFFFFFFFFFFFFEEEEDEEEDEDCDCDCCCCBBAAAA999988887777666555544433333323211111111000000000000000000000000000100100111212133333344344555566667775E00888AAABBBCCDDEEEFFFFFFFFFFFFFFFEEEEEDCCCBAAA998877655444332211100000000000000011122223345556672F0079ABCDDDFFFFFFFFEEDCBB98765432111000000012244560180089CDFFFFFDBA8631000012350C008CFFFB83000306007EE80103007E007901FFFFFFFFFFEFFFEEEFEEEDEEDDDDDDDCDCDCCDDCCCCCCCBCCCBBCBBAAAABABBABAA9AAA9A99999998999888888788877877777777676766666666565555555555455444443343333333333233223223222121122111111010000000000000000000110000110111112122112222222233223323333333433444444454555555555566666666666677777777778877788888889899989999999A9AAAAAAAAABBAAABBBBBBBCBBCCCCCCCCCCCDDDDDDDEDDDEEEEEEEEFEEFFFFFFFFFFFF0BC00FFFFFFFFEEEEEDDDDCCCCCCBCBBBAABAAAAA99988888888777777776655656555554344433332222212111111100000000001011112212223333343444444455656667766678788888989999A9AAAAAABBBCBCBBDCCDDDDDDDDEEFEFFFFF5E00FFFEFEEDCDCBBBBBA9A998877776665545443323211000000001121323344555566667788899AAABBBCCCDDEEEEFFF2F00FEEDDCBBA998766553331210011224445668899ABBDDEEF01800FEDBA976542001335678ABDE790100000000000000000101010111111011111111121211222212221221212222222222222223333332333333333333344433344334444454454444445455555545555555556556556655656666666666676666676767777777777777888787888877888788888888889889899999998999999999999999AA99A9AAAAAAAAABBBAAABBAAABABBBBBBBBBBCBBBCBBCBBCCBCCBCBCCCCCCCCDDDCDDDCDCDDCDDCDDDDDDDDDDEDDDDDEEEEEEDEEEEFEEFEEEEEFFFEFFFFFEFFFFFFFFFFFFFFF0BC0000000000000111001111111112222222222322333333333444444444455454555555655666666666666777777787777878888889888999999999AAAAAA9AAAABBABABBBBBCBBCCBCBCCCCCDDCCDCCDDDDDDDEEEEEEEEFEFEFFFEFFFFFFFF5E0000000001111112222232333333455445556656667677778788889999999AAAAAABBBBCBBCCCDDCDDDDEDDEFFEEFFFF2F00000011222233344555666777889899AABABBCCDDDDEEEFF01800001233445667889AABCCDDEFBC007899AACCDDDDEEEFFFFFFFFEEEEDDCBBBA9997867565554333332233333334444555557777777888889898888887787878777667777777777888899AAAAAABBBCCCCCDDDCCCCCCBABAA99887765544332221110000000001112333444567BC00789ACCDDEEEFFFFFEFFDDDCBA987755443221121111222344455778899AABBBBBBBBBBBAAA999888887777767777778788888888887887777666554454444444555666789A9BBCCDDDEEEEDEDDDCCBA98866554222100000000012234556BC0088ABCDDEFFFFFFEEDBAA876543321111011233456678AAABCDDCDDCCBBA9A88776656555545565667677887888888888877777788788989AAAAAAAABAAA9877765444323322233445688AABCDDEEEEFEDDDCBA8766432210000000123456BC0089ACDEFFFFFFEDCB98654311001012245678AACCDEDDDDCBAA98666444443344556778999A9AAA9999888877787778788888888777766656556666678999ABBBCCCCBAA987665322122222346779ACCEDEFFEEDCCA976432200000022446BC0089BCEFFFFFECB987432110001235689BCDEEEEDDCB9876433322334556899AABBCBBA9988766655566667788888888877877878889999999989877664544444466889ACCCDDDCBBA97653221111235678ABDEFFFFDDCA875421000002346BC0079BDEFFFFDCB864320000124689BCEEEEEDCA975432111235678AACCDDCBA9876555445556788899A99998878878778888788776665565667789AAABAAA99876544333355689ACCDDEDCCA875431011234679BCEEFFEDCA875210000124520000000000000000000FFFFFFFFFFFFFFFF000080E03E80F03DC980F5E3CB65E1C8D610C9032B233E03D3007E1F3801001F300230001FD2EDA6001FD2F3A60000E60F3C3D20FDD3007E2F1F3801001F300230001FD20BA7001FD211A70000E60F3C3D20FD0B78B1C2D9A6C90356233E03D3007A0F3801000F300230000FD234A7000FD23AA70000AFD3007A0F3001000F380238000FDA4CA7000FDA52A70000E60F20027E23CA5DA70000570B78B1C221A7C90356237B1F300230001FD273A7001FD279A70000E61F3C3D20FD3E03D3007A0F3801000F300230000FD292A7000FD298A70000AFD3007A0F3001000F380238000FDAAAA7000FDAB0A70000E60F20027E23CABBA70000570B78B1C268A7C922DAA7ED43DDA7C3DFA7DB04E608C83E003E00C3E2A721000001010056DD2B7B1F300230001FD2EDA7001FD2F3A70000E61F3C3D20FD3E03D3007A07D204A8000007D209A800073002300007380100AFD3007A07DA1CA8000007DA21A800073802380007300100E6F02002237ECA35A8000057DD7CDDB5C80B78B1C2CDA7C3D9A7225AA8ED435DA82BDB03CB5FC823C35FA81B7AB3C82100000101003E03D3007E1F3801001F300230001FD272A8001FD278A80000E60F3C3D20FDD3007E2F1F3801001F300230001FD290A8001FD296A80000E60F3C3D20FD0B78B128B4C24CA83E03D300781F3801001F300230001FD2B7A8001FD2BDA80000E60F3C3D20FDD300782F1F3801001F300230001FD2D5A8001FD2DBA80000E60F3C3D20FDE93E03D300780F3801000F300230000FD2F5A8000FD2FBA80000AFD300780F3001000F380238000FDA0DA9000FDA13A90000E9"
